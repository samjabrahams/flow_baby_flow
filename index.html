<!DOCTYPE html>
<html>
<head>
	<style>
		body, html {
			height: 100%;
			margin: 0;
			padding: 0;
		}

		body {
			background-color: #000;
		}

		#map {
			height: 700px;
		}
	</style>
	<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.7/mapbox.js'></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src='http://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.7/mapbox.css' rel='stylesheet' />
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
	<script>
		var geojson;

		var colorIndex = 0;

		var DEFAULT_COLOR = '#444444';

		var date = "2000-07-01T00:00:00Z";

		var storeJSON = [];

		var colorArray = [
			'#D1000F',
			'#C0001A',
			'#B00126',
			'#A00231',
			'#8F033D',
			'#7F0448',
			'#6F0454',
			'#5E055F',
			'#4E066B',
			'#3E0776',
			'#2E0882'];

		function style(feature) {
			return {
				fillColor: colorLogic(feature.properties.STATE + feature.properties.COUNTY),
				weight: 1,
				opacity: 0.7,
				color: 'white',
				dashArray: '3',
				fillOpacity: 0.7
			};
		}

		function colorLogic(countyID) {
			var key = "";
			var colorHex;
			
			if (storeJSON[date].Value) {
				colorHex = pickColor(storeJSON[date].Value);
			} else {
				colorHex = DEFAULT_COLOR;
			}

			return colorHex;
			
		}

		// dataURL is a url to a JSON object
		// Date is a date. Format to follow
		/*
		function connectData(dataURL) {
			$.getJSON(dataURL, function(data) {
				//date = date + "T00:00:00Z";
				storeJSON = data;

			});
		}
		*/

		function highlightFeature(e) {
			var layer = e.target;
			layer.setStyle({
				weight: 2,
				color: '#F00',
				fillOpacity: 1.0
			});

			if (!L.Browser.ie && !L.Browser.opera) {
				layer.bringToFront();
			}
		}

		function resetHighlight(e) {
			geojson.resetStyle(e.target);
		}

		function onEachFeature(feature, layer) {
			layer.on({
				mouseover: highlightFeature,
				mouseout: resetHighlight
			});
		}
		
		function attachDataToMap(dataURL, map) {
			$.getJSON('data/51011.json', function(data) {
				
				console.log("attaching data to map");

				storeJSON = data;

				$.getJSON(dataURL, function(data) {
				geojson = L.geoJson(data, {
					style: style,
					onEachFeature: onEachFeature
				}).addTo(map);
			
				});
			})
			
		}

		function changeColorTest(geojson) {
			if (colorIndex >= colorArray.length || colorIndex < 0) {
				console.log("resetting index!");
				colorIndex = 0;
			}

			console.log("color is " + colorArray[colorIndex]);

			geojson.setStyle({
				fillColor: colorArray[colorIndex]
			});

			colorIndex++;
		}

		function pickColor(value) {
			// DUMMY VALUES, BETWEEN 0 AND 200
			console.log("Value is: " + value);
			var MEDIAN = 500.0;
			var MAX = 1000.0;

			if (value < MEDIAN) {
				var percent = value / MEDIAN;
				return getGradientColor('#ffffd9', '#41b6c4', percent);
			} else {
				var percent = (value - MEDIAN) / (MAX - MEDIAN);
				return getGradientColor('#41b6c4', '#081d58', percent);
			}
		}

		// http://stackoverflow.com/a/27709336
		function getGradientColor(start_color, end_color, percent) {
			// strip the leading # if it's there
			start_color = start_color.replace(/^\s*#|\s*$/g, '');
			end_color = end_color.replace(/^\s*#|\s*$/g, '');

			// convert 3 char codes --> 6, e.g. `E0F` --> `EE00FF`
			if(start_color.length == 3){
				start_color = start_color.replace(/(.)/g, '$1$1');
			}

			if(end_color.length == 3){
				end_color = end_color.replace(/(.)/g, '$1$1');
			}

			// get colors
			var start_red = parseInt(start_color.substr(0, 2), 16),
			start_green = parseInt(start_color.substr(2, 2), 16),
			start_blue = parseInt(start_color.substr(4, 2), 16);

			var end_red = parseInt(end_color.substr(0, 2), 16),
			end_green = parseInt(end_color.substr(2, 2), 16),
			end_blue = parseInt(end_color.substr(4, 2), 16);

			// calculate new color
			var diff_red = end_red - start_red;
			var diff_green = end_green - start_green;
			var diff_blue = end_blue - start_blue;

			diff_red = ( (diff_red * percent) + start_red ).toString(16).split('.')[0];
			diff_green = ( (diff_green * percent) + start_green ).toString(16).split('.')[0];
			diff_blue = ( (diff_blue * percent) + start_blue ).toString(16).split('.')[0];

			// ensure 2 digits by color
			if( diff_red.length == 1 )
				diff_red = '0' + diff_red

			if( diff_green.length == 1 )
				diff_green = '0' + diff_green

			if( diff_blue.length == 1 )
				diff_blue = '0' + diff_blue

			return '#' + diff_red + diff_green + diff_blue;
		};

		window.onload = function() {
			var map = L.map('map').setView([39.52, -98.4], 5);

			L.tileLayer('https://{s}.tiles.mapbox.com/v4/samjabrahams.ln53g9ef/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic2FtamFicmFoYW1zIiwiYSI6IlFYaEFqQWcifQ.wKho1oe6MY2xAtQ1uOYWrg').addTo(map);

			attachDataToMap('stateGeo.json', map);	
			//connectData('data/51011.json');

			// TEST HURRICANE KML FILE
			//omnivore.kml('test_kml.kml').addTo(map);		

			$('#remove').click(function() {
				geojson.clearLayers();
				setTimeout(function() {
					attachDataToMap('stateGeo.json', map)
				}, 4000 );
			});

			$('#color').click(function() {
				setInterval(function() {
					changeColorTest(geojson);
				}, 17);
			});
			
			

		}		
	</script>

</head>
<body>
	<div id="map"></div>
	<button type="button" id="remove" value="clear">Clear the JSON Layer!</button>
	<button type="button" id="color" value="color">Begin the coloration!</button>
</body>
	
</html>
